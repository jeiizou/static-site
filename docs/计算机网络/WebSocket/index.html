<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-计算机网络/WebSocket">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">WebSocket | world</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://localhost:3000/docs/计算机网络/WebSocket"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="WebSocket | world"><meta data-rh="true" name="description" content="构建网络应用过程中, 有时需要长连接来进行频繁的数据通信或者获取服务主动信息. WebSocket是一种经典并且很常用的长连接方案."><meta data-rh="true" property="og:description" content="构建网络应用过程中, 有时需要长连接来进行频繁的数据通信或者获取服务主动信息. WebSocket是一种经典并且很常用的长连接方案."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://localhost:3000/docs/计算机网络/WebSocket"><link data-rh="true" rel="alternate" href="https://localhost:3000/docs/计算机网络/WebSocket" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://localhost:3000/docs/计算机网络/WebSocket" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="world RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="world Atom Feed"><link rel="stylesheet" href="/assets/css/styles.5d8c6f17.css">
<link rel="preload" href="/assets/js/runtime~main.0fe2848a.js" as="script">
<link rel="preload" href="/assets/js/main.755b20c3.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_B8Ea">跳到主要内容</a></div><nav class="navbar navbar--fixed-top navbarHideable_cmch"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Jeiiz&#x27;s World</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Wiki</a><a class="navbar__item navbar__link" href="/blog">Blog</a><div class="toggle_Wbdk colorModeToggle_qKyZ"><button class="clean-btn toggleButton_ZMwS toggleButtonDisabled_bkOl" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v5D6"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_ZxuA"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_aLgs"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_Bh6J docsWrapper_Q1yX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_wVrL" type="button"></button><div class="docPage_ZAu3"><aside class="theme-doc-sidebar-container docSidebarContainer_ZFCQ"><div class="sidebar_d_V8 sidebarWithHideableNavbar_DHfV"><a tabindex="-1" class="sidebarLogo_VhE4" href="/"><b>Jeiiz&#x27;s World</b></a><nav class="menu thin-scrollbar menu_mA06"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/信息安全/网络安全/安全-常见安全策略">信息安全</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/其他/Git/Git-GitFlow">其他</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/前端基础/CSS/原理-像素与单位">前端基础</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/前端生态/前端工程/Babel/Babel-插件">前端生态</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/图形学/WebGL-GLSL语法">图形学</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/数据结构与算法/DFS&amp;BFS">数据结构与算法</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/服务端/Nginx常用配置">服务端</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/架构&amp;模式&amp;工程/ShapeUp工作流">架构&amp;模式&amp;工程</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/计算机网络/CDN原理">计算机网络</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/计算机网络/CDN原理">CDN原理</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/计算机网络/HTTP/">HTTP</a><button aria-label="打开/收起侧边栏菜单「HTTP」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/计算机网络/TCP&amp;UDP">TCP&amp;UDP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/计算机网络/WebSocket">WebSocket</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/计算机网络/上传与下载">上传与下载</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/计算机网络/网络模型概述">网络模型概述</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_l9Db"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_lDak"><div class="docItemContainer_Nuls"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_MUoR" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_API8"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">计算机网络</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">WebSocket</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_FtTS theme-doc-toc-mobile tocMobile_l5fy"><button type="button" class="clean-btn tocCollapsibleButton_Dnbe">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>WebSocket</h1><p>构建网络应用过程中, 有时需要长连接来进行频繁的数据通信或者获取服务主动信息. WebSocket是一种经典并且很常用的长连接方案. </p><h2 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="其他轮询方式">其他轮询方式<a class="hash-link" href="#其他轮询方式" title="标题的直接链接">​</a></h2><p>在此之前, 先介绍几种常用方案:</p><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="传统轮询">传统轮询<a class="hash-link" href="#传统轮询" title="标题的直接链接">​</a></h3><p>传统轮询比较简单, 可以使用<code>setInterval</code>或者<code>setTimeout</code>实现:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">setInterval</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/path/to/server&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者使用<code>settimeout</code>, 保证本次数据的前提下发起下一次请求:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">poll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/path/to/server&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">data</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 发起下一次请求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">poll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="长轮询">长轮询<a class="hash-link" href="#长轮询" title="标题的直接链接">​</a></h3><p>短轮询的问题是每次请求会新建一个HTTP请求, 然而并不是每次都能返回需要的新数据. 长轮询的基本思想是每次客户端发出请求后, 服务器检查上次返回的数据于此请求时的数据之间是否更新, 如果有则返回新数据并结束链接, 否则, 服务器<code>pending</code>, 直到有新的数据返回, 并且可以设置一个比较大的<code>HTTP timeout</code>, 下面是一个简单长连接示例(长轮询依赖服务器支持并且实现):</p><p>PHP:</p><div class="language-php codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-php codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 示例数据为data.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $filename= dirname(__FILE__).&quot;/data.txt&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 从请求参数中获取上次请求到的数据的时间戳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $lastmodif = isset( $_GET[&quot;timestamp&quot;])? $_GET[&quot;timestamp&quot;]: 0 ;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 将文件的最后一次修改时间作为当前数据的时间戳</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $currentmodif = filemtime($filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 当上次请求到的数据的时间戳*不旧于*当前文件的时间戳，使用循环&quot;hold&quot;住当前连接，并不断获取文件的修改时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while ($currentmodif &lt;= $lastmodif) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 每次刷新文件信息的时间间隔为10秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        usleep(10000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 清除文件信息缓存，保证每次获取的修改时间都是最新的修改时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clearstatcache();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $currentmodif = filemtime($filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 返回数据和最新的时间戳，结束此次连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $response = array();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $response[&quot;msg&quot;] =Date(&quot;h:i:s&quot;).&quot; &quot;.file_get_contents($filename);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $response[&quot;timestamp&quot;]= $currentmodif;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    echo json_encode($response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">?&gt;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>JS:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">longPoll</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> _timestamp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/path/to/server?timestamp=&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">done</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">res</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            _timestamp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">timestamp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">always</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">setTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">longPoll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_timestamp </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token known-class-name class-name">Date</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>长轮询可以有效的解决带宽浪费问题, 但是每次连接保持都会消耗服务器资源, 尤其是对于apache+php的服务器, 对于长连接数量过多会丢失响应. </p><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="服务器发送事件server-sent-event">服务器发送事件(Server-Sent Event)<a class="hash-link" href="#服务器发送事件server-sent-event" title="标题的直接链接">​</a></h3><p>服务器推送(SSE)是HTML5的一个规范, 可以实现服务器到客户端的单向数据通行. 通过SSE, 客户端可以自动获取数据更新, 不用重复发送HTTP, 一旦连接建立, <code>事件</code>就会自动被推送到和护短, 服务端通过SSE通过事件流的格式产生并推送事件, 事件对应的MIME为<code>text/event-stream</code>, 包含四个字段: </p><ul><li>event:事件类型; </li><li>data: 消息类型; </li><li>id: 客户端EventSource对象的<code>last event ID string</code>; </li><li>retry: 指定了重新连接的时间.</li></ul><p>服务端代码:</p><div class="language-php codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-php codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token plain">&lt;?php</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header(&quot;Content-Type: text/event-stream&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    header(&quot;Cache-Control: no-cache&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 每隔1秒发送一次服务器的当前时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while (1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        $time = date(&quot;r&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;event: ping\n&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        echo &quot;data: The server time is: {$time}\n\n&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ob_flush();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        flush();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sleep(1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">?&gt;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而在客户端中, SSE借由<code>EventSource</code>对象实现, <code>EventSource</code>包含五个额外属性:</p><ul><li>onerror</li><li>onmessage</li><li>onopen</li><li>readyState</li><li>url</li></ul><p>以及两个内部属性: <code>reconnection time</code> 和 <code>last event</code>, 在<code>onerror</code>属性中我们可以对错误捕获和处理, 而<code>onmessage</code>则对应着服务器事件的接受和处理. 另外也可以使用<code>addEventListener</code>方法来监听服务器发送事件, 根据<code>event</code>字段区分处理. </p><p>客户端:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> eventSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">EventSource</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;/path/to/server&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eventSource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmessage</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 或者</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eventSource</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ping&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">event</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>SSE相较于轮询具有较好的实时性, 使用方法也非常简便. 然而SSE只支持服务端到客户端单向的事件推送, 而且兼容性也存在一定的问题:</p><p><img loading="lazy" alt="image" src="/assets/images/sse-cdc21ef99c2bda544bef39fabec12ccb.jpeg" width="1251" height="379" class="img_wb0S"></p><h2 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="websocket简介">WebSocket简介<a class="hash-link" href="#websocket简介" title="标题的直接链接">​</a></h2><p>在2008年, websocket诞生了, 2011年成为了国际标准, 目前为止, 所有浏览器都已经支持. </p><p>WebSocket同样是HTML5规范的组成部分之一, 其实现原理较为复杂, 简单来说: </p><ol><li>客户端向<code>WebSocket</code>服务端通知(notify)一个带有所有<code>接受者ID(recipients IDS)</code>的事件(event), </li><li>服务器接收后通知所有活跃的客户端, 只有ID在接受者ID序列中的客户端才会处理这个事件. </li><li>由于WebSocket本身基于TCP协议, 所以在服务器端我们可以采用构建<code>TCP Socket</code>服务器的方式来构建<code>WebSocket</code>服务器. </li></ol><p>WebSocket是一种全新的协议, 它将TCP的<code>Socket</code>应用在了<code>web page</code>上, 从而使通行双方建立一个保持在活动状态的连接通道, 并且属于全双工.</p><p>WebSocket协议是借用HTTP协议的<code>101 switch protocol</code>来达到协议转换, 从而使通行双方切换成<code>websocket</code>通信协议. </p><p>其最大的特点是通信双方都可以主动发起消息推送, 其他特点包括且不限于:</p><ul><li>建立在TCP协议之上, 服务端的实现比较容易</li><li>与HTTP协议有良好的兼容性. 默认端口是80和443, 并且握手阶段采用HTTP协议, 因此握手时可以通过各种HTTP代理服务器. </li><li>数据格式比较轻量, 新能开销小, 通信高效.</li><li>可以发送文本, 也可以发送二进制数据</li><li>没有同源限制, 客户端可以有任意服务器通行</li><li>协议标识符为<code>ws</code>, 如果加密则为<code>wss</code>, 服务器网址就是当前的<code>URL</code>.</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="协议介绍">协议介绍<a class="hash-link" href="#协议介绍" title="标题的直接链接">​</a></h2><p>websocket协议被设计来取代现有的使用HTTP作为传输层的双向通信技术, 并受益于现有的基础设施(代理, 过滤, 身份验证).</p><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="协议概述">协议概述<a class="hash-link" href="#协议概述" title="标题的直接链接">​</a></h3><p>协议有两部分, 握手和数据传输. </p><p>其中来自客户端的握手看起来类似:</p><div class="codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-text codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token plain">GET /chat HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: server.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Upgrade: websocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection: Upgrade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Origin: http://example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sec-WebSocket-Protocol: chat, superchat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sec-WebSocket-Version: 13</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>而来自于服务器的握手看起来像:</p><div class="codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-text codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 101 Switching Protocols</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Upgrade: websocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection: Upgrade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sec-WebSocket-Protocol: chat</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>来自客户端的首行遵循<code>Request-Line</code>格式, 来自服务器的首行遵照<code>Status-Line</code>格式. (<a href="http://tools.ietf.org/html/rfc2616" target="_blank" rel="noopener noreferrer">RFC2616</a>)</p><p>一旦客户端和服务器都发送了握手, 且握手成功, 接着开始数据传输部分, 这是每一端都可以的双向通信信道, 批次独立且随意发送数据. </p><p>一个成功握手之后, 客户端和服务端来回的传输数据. 规范中的概念单位为&quot;消息&quot;. 这线路上, 一个消息由一个或多个帧组成. WebSocket的消息并不一定对应一个特定的网络层帧, 可以作为一个可以被中间合并或拆分的片段消息. </p><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="握手">握手<a class="hash-link" href="#握手" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="客户端-申请协议升级">客户端: 申请协议升级<a class="hash-link" href="#客户端-申请协议升级" title="标题的直接链接">​</a></h4><p>首先客户端发起协议升级请求, 可以看到采用标准的HTTP报文, 且只支持GET方法:</p><div class="codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-text codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token plain">GET / HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: localhost:8080</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Origin: http://127.0.0.1:3000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection: Upgrade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Upgrade: websocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sec-WebSocket-Version: 13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sec-WebSocket-Key: w4v7O6xFTi36lq3RNcgctw==</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重点请求首部意义如下:</p><ul><li><code>Connection: Upgrade</code>: 表示要升级协议</li><li><code>Upgrade: websocket</code>: 表示要升级到websocket协议</li><li><code>Sec-WebSocket-Version: 13</code>: 表示websocket的版本. 如果服务端不支持该版本, 需要返回一个<code>Sec-WebSocket-Versionheader</code>, 里面包含服务端支持的版本号. </li><li><code>Sec-WebSocket-Key</code>: 与后面服务端响应首部的<code>Sec-WebSocket-Acccept</code>是配套的, 提供基本的防护, 比如恶意或无意的连接. </li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="服务端-响应协议升级">服务端: 响应协议升级<a class="hash-link" href="#服务端-响应协议升级" title="标题的直接链接">​</a></h4><p>服务端返回内容如下:</p><div class="codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-text codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 101 Switching Protocols</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Connection:Upgrade</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Upgrade: websocket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sec-WebSocket-Accept: Oy4NRAQ13jhfONC7bP8dTKb4PTU=</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>状态码101表示协议切换. 到此完成协议升级, 后续的数据交互都按照新的协议来</p></li><li><p><code>Sec-WebSocket-Accept</code>: 根据客户端请求首部的<code>Sec-WebSocket-Key</code>计算出来的. 计算步骤:</p><ol><li>将<code>Sec-WebSocket-Key</code>跟<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>拼接</li><li>通过SHA1计算摘要, 转为base64字符串</li></ol></li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="数据帧">数据帧<a class="hash-link" href="#数据帧" title="标题的直接链接">​</a></h3><p>websocket通行的最小单位是帧(frame), 由1或多个帧组成一条完整的消息.</p><ul><li>发送端: 将消息切割成多个帧, 并发送给接收端</li><li>接收端: 接收消息帧, 并将关联的帧组装成完整的消息</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="数据帧格式概览">数据帧格式概览<a class="hash-link" href="#数据帧格式概览" title="标题的直接链接">​</a></h4><p>用于数据传输部分的报文格式是通过ABNF来描述的. </p><p>下面是WebSocket数据帧的格式:</p><div class="codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-text codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token plain">0                   1                   2                   3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +-+-+-+-+-------+-+-------------+-------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> | |1|2|3|       |K|             |                               |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |     Extended payload length continued, if payload len == 127  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> + - - - - - - - - - - - - - - - +-------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |                               |Masking-key, if MASK set to 1  |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +-------------------------------+-------------------------------+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> | Masking-key (continued)       |          Payload Data         |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +-------------------------------- - - - - - - - - - - - - - - - +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> :                     Payload Data continued ...                :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> |                     Payload Data continued ...                |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> +---------------------------------------------------------------+</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>从左到有, 单位为比特, 内容包含了标识, 操作代码, 掩码, 数据, 数据长度等.</p><p>下面是详细解释:</p><ul><li>FIN(1 bit): 如果为1, 表示这是最后一个分片, 否则还有后续分片.</li><li>RSV1, RSV2, RSV3(1 bit,1 bit,1 bit): 一般全为0, 当客户端, 服务端协商采用websocket扩展时, 这三个标志位可以非0, 且值的含义由扩展进行定义. 如果出现非0只, 且没有采用websocket扩展, 连接出错. </li><li>Opcode(4 bit): 操作代码, Opcode的值决定了应该如何解析后续的数据载荷(data payload). 如果操作代码是不认识的, 那么接受端应该断开链接(fail the connection), 可选的操作代码如下:<ul><li>%x0: 表示一个延迟帧, 当为0时, 表示本次数据传输采用了数据分片, 当前收到的数据帧为其中一个数据分片</li><li>%x1: 表示这是一个文本帧</li><li>%x2: 表示这是一个二进制帧</li><li>%x3-7: 保留的操作代码, 用于后续定义的非控制帧</li><li>%x8: 表示连接断开</li><li>%xA: 表示这是一个pong操作</li><li>%xB-F: 保留的操作代码, 用于后续定义的控制帧</li></ul></li><li>Mask(1 bit): 表示是否要对数据载荷进行掩码操作. 从客户端向服务端发送数据时, 需要对数据进行掩码操作, 从服务端向客户端发送数据则不需要. 如果Mask是1, 则在<code>Masking-key</code>会定义一个<code>masking key</code>, 并用这个掩码来对数据载荷进行反掩码, 所有客户端发送到服务端的数据帧, Mask都为1. </li><li>payload length: 数据载荷的长度, 单位为字节, 7 bit或者7+16 bit或者1+64 bit. 假设Payload length===x, 若:<ul><li>x为0~126: 数据的长度为x字节</li><li>x为126: 后续2个字节代表一个16位的无符号整数, 该无符号整数的值为数据的长度</li><li>x为127: 后续8个字节代表一个64位的无符号整数, 概无符号整数的值为数据的长度</li><li>此外如果占用多个字节, payload length的二进制表达采用网络序(big endian, 重要的位在前)</li></ul></li><li>Masking-key(0或4 bit): 所有从客户端传送到服务端的数据帧，数据载荷都进行了掩码操作，Mask 为 1，且携带了 4 字节的 Masking-key。如果 Mask 为 0，则没有 Masking-key。</li><li>Payload data：(x+y) 字节:<ul><li>载荷数据: 包括了扩展数据, 应用数据. 其中, 扩展数据x字节, 应用数据y字节</li><li>扩展数据: 如果没有写上使用扩展的话, 扩展数据为0字节, 所有的扩展都必须声明扩展数据的长度, 或者可以如何计算出扩展的长度. 此外, 扩展如何使用必须在握手阶段就协商好, 若果扩展数据存在, 那么载荷数据长度必须将扩展数据的长度包含在内. </li><li>应用数据: 任意的应用数据, 在扩展数据之后, 占据了数据帧剩余的位置. 载荷数据长度减去扩展数据长度, 就得到应用数据的长度</li></ul></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="掩码算法">掩码算法<a class="hash-link" href="#掩码算法" title="标题的直接链接">​</a></h4><p>掩码键（Masking-key）是由客户端挑选出来的 32 位的随机数。掩码操作不会影响数据载荷的长度。掩码、反掩码操作都采用如下算法：</p><p>首先假设:</p><ul><li><code>original-octet-i</code>：为原始数据的第 i 字节。</li><li><code>transformed-octet-i</code>：为转换后的数据的第 i 字节。</li><li><code>j</code>：为i mod 4的结果。</li><li><code>masking-key-octet-j</code>：为 mask key 第 j 字节。</li></ul><p>算法描述如下:</p><div class="codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-text codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token plain">j  = i MOD 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transformed-octet-i = original-octet-i XOR masking-key-octet-j</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="数据传递">数据传递<a class="hash-link" href="#数据传递" title="标题的直接链接">​</a></h3><p>一旦WebSocket链接建立, 后续的操作就是基于数据帧的传递. </p><p>WebSocket根据opcode来区分操作的类型. 比如0x8表示断开链接, 0x0-0x2表示数据交互. </p><h4 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="数据分片">数据分片<a class="hash-link" href="#数据分片" title="标题的直接链接">​</a></h4><p>WebSocket的每条消息可能被切分为多个数据帧, 当WebSocket的接收方收到一个数据帧是, 会根据FIN判断是否为最后一个数据帧. </p><p>此外, opcode在数据交换的场景下, 表示的是数据的类型.</p><h4 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="连接保持心跳">连接保持+心跳<a class="hash-link" href="#连接保持心跳" title="标题的直接链接">​</a></h4><p>WebSocket为了保持客户端, 服务端的实施双向通信, 需要确保客户端, 服务端之间的TCP通道保持连接没有断开. 然而, 对于长时间没有数据往来的连接, 如果依旧长时间保持着, 可能会浪费包括的链接资源. </p><p>但不排除某些场景下, 客户端, 服务端虽然没有数据往来, 单人需要保持连接. 这个时候可以采用心跳来实现:</p><ul><li>发送方=&gt;接收方: ping</li><li>接收方=&gt;发送方: pong</li></ul><p>ping, pong的操作对应WebSocket的两个控制帧, opcode分别是<code>0x9</code>, <code>0xA</code>.</p><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="关闭连接">关闭连接<a class="hash-link" href="#关闭连接" title="标题的直接链接">​</a></h3><p>一旦发送或收到一个close控制帧, 这就是说, WebSocket关闭阶段握手已启动, 且WebSocket连接处理CLOSING状态. </p><p>当底层TCP连接已关闭, 这就是说WebSocket连接已关闭且WebSocket连接处于CLOSED状态. 如果TCP连接在WebSocket关闭阶段已经完成后被关闭, WebSocket连接就是被完全地关闭了. </p><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="状态码">状态码<a class="hash-link" href="#状态码" title="标题的直接链接">​</a></h3><p>当关闭一个已经建立的连接, 端点可以表明关闭的原因. 由端点解释这个原因, 并且端点应该给这个原因采取动作, 本规范是没有定义的, 本规范定义了一组预定义的状态码, 并制定那些范围可以被扩展, 框架和最终应用使用. 状态码和任何相关的文本消息是关闭帧可选的组件. </p><table><thead><tr><th>状态码</th><th>名称</th><th>描述</th></tr></thead><tbody><tr><td>0–999</td><td></td><td>保留段, 未使用.</td></tr><tr><td>1000</td><td>CLOSE_NORMAL</td><td>正常关闭; 无论为何目的而创建, 该链接都已成功完成任务.</td></tr><tr><td>1001</td><td>CLOSE_GOING_AWAY</td><td>终端离开, 可能因为服务端错误, 也可能因为浏览器正从打开连接的页面跳转离开.</td></tr><tr><td>1002</td><td>CLOSE_PROTOCOL_ERROR</td><td>由于协议错误而中断连接.</td></tr><tr><td>1003</td><td>CLOSE_UNSUPPORTED</td><td>由于接收到不允许的数据类型而断开连接 (如仅接收文本数据的终端接收到了二进制数据).</td></tr><tr><td>1004</td><td></td><td>保留. 其意义可能会在未来定义.</td></tr><tr><td>1005</td><td>CLOSE_NO_STATUS</td><td>保留.  表示没有收到预期的状态码.</td></tr><tr><td>1006</td><td>CLOSE_ABNORMAL</td><td>保留. 用于期望收到状态码时连接非正常关闭 (也就是说, 没有发送关闭帧).</td></tr><tr><td>1007</td><td>Unsupported Data</td><td>由于收到了格式不符的数据而断开连接 (如文本消息中包含了非 UTF-8 数据).</td></tr><tr><td>1008</td><td>Policy Violation</td><td>由于收到不符合约定的数据而断开连接. 这是一个通用状态码, 用于不适合使用 1003 和 1009 状态码的场景.</td></tr><tr><td>1009</td><td>CLOSE_TOO_LARGE</td><td>由于收到过大的数据帧而断开连接.</td></tr><tr><td>1010</td><td>Missing Extension</td><td>客户端期望服务器商定一个或多个拓展, 但服务器没有处理, 因此客户端断开连接.</td></tr><tr><td>1011</td><td>Internal Error</td><td>客户端由于遇到没有预料的情况阻止其完成请求, 因此服务端断开连接.</td></tr><tr><td>1012</td><td>Service Restart</td><td>服务器由于重启而断开连接.</td></tr><tr><td>1013</td><td>Try Again Later</td><td>服务器由于临时原因断开连接, 如服务器过载因此断开一部分客户端连接.</td></tr><tr><td>1014</td><td></td><td>由 WebSocket 标准保留以便未来使用.</td></tr><tr><td>1015</td><td>TLS Handshake</td><td>保留. 表示连接由于无法完成 TLS 握手而关闭 (例如无法验证服务器证书).</td></tr><tr><td>1016–1999</td><td></td><td>由 WebSocket 标准保留以便未来使用.</td></tr><tr><td>2000–2999</td><td></td><td>由 WebSocket 拓展保留使用.</td></tr><tr><td>3000–3999</td><td></td><td>可以由库或框架使用.不应由应用使用. 可以在 IANA 注册, 先到先得.</td></tr><tr><td>4000–4999</td><td></td><td>可以由应用使用.</td></tr></tbody></table><h2 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="客户端api">客户端API<a class="hash-link" href="#客户端api" title="标题的直接链接">​</a></h2><p>创建一个WebSocket实例:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token maybe-class-name">WebSocket</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">WebSocket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token maybe-class-name">DOMString</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> optional </span><span class="token maybe-class-name">DOMString</span><span class="token plain"> protocols</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token maybe-class-name">WebSocket</span><span class="token plain"> </span><span class="token function maybe-class-name" style="color:#d73a49">WebSocket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token maybe-class-name">DOMString</span><span class="token plain"> url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> optional </span><span class="token maybe-class-name">DOMString</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> protocols</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>参数:</p><ul><li>url: 表示要链接的URL, 应为响应的WebSocket地址</li><li>protocols: 可选, 单个协议字符串或者多个协议名字字符串的数组. 这些字符串用来表示子协议, 这样做可以让一个服务器实现多种WebSocket子协议, 如果没有指定这个参数, 它会默认一个空的字符串. </li></ul><p>异常:</p><ul><li><code>SECRITY_ERR</code>: 连接端口被屏蔽</li></ul><p>代码:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> ws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">WebSocket</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;ws://localhost:8080&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>实例方法:</p><table><thead><tr><th>属性名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>binaryType</td><td>DOMString</td><td>一个字符串表示被传输二进制的内容的类型。取值应当是&quot;blob&quot;或者&quot;arraybuffer&quot;。&quot;blob&quot;表示使用DOM Blob 对象，而&quot;arraybuffer&quot;表示使用 ArrayBuffer 对象。</td></tr><tr><td>bufferedAmount</td><td>unsigned long</td><td>调用 send() 方法将多字节数据加入到队列中等待传输，但是还未发出。该值会在所有队列数据被发送后重置为 0。而当连接关闭时不会设为0。如果持续调用send()，这个值会持续增长。只读。</td></tr><tr><td>extensions</td><td>DOMString</td><td>服务器选定的扩展。目前这个属性只是一个空字符串，或者是一个包含所有扩展的列表。</td></tr><tr><td>onclose</td><td>EventListener</td><td>用于监听连接关闭事件监听器。当 WebSocket 对象的readyState 状态变为 CLOSED 时会触发该事件。这个监听器会接收一个叫close的 CloseEvent 对象。</td></tr><tr><td>onerror</td><td>EventListener</td><td>当错误发生时用于监听error事件的事件监听器。会接受一个名为“error”的event对象。</td></tr><tr><td>onmessage</td><td>EventListener</td><td>一个用于消息事件的事件监听器，这一事件当有消息到达的时候该事件会触发。这个Listener会被传入一个名为&quot;message&quot;的 MessageEvent 对象。</td></tr><tr><td>onopen</td><td>EventListener</td><td>一个用于连接打开事件的事件监听器。当readyState的值变为 OPEN 的时候会触发该事件。该事件表明这个连接已经准备好接受和发送数据。这个监听器会接受一个名为&quot;open&quot;的事件对象。</td></tr><tr><td>protocol</td><td>DOMString</td><td>一个表明服务器选定的子协议名字的字符串。这个属性的取值会被取值为构造器传入的protocols参数。</td></tr><tr><td>readyState</td><td>unsigned short</td><td>连接的当前状态。取值是 Ready state constants 之一。 只读。</td></tr><tr><td>url</td><td>DOMString</td><td>传入构造器的URL。它必须是一个绝对地址的URL。只读。</td></tr></tbody></table><p>常用的三个监听事件:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//指定连接成功后的回调函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onopen</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Hello Server!&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 多个回调函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;open&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;Hello Server!&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 指定连接关闭后的回调函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onclose</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">reason</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> wasClean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">wasClean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// handle close event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;close&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> code </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">code</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">reason</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> wasClean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">wasClean</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// handle close event</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 指定收到服务器数据后的回调函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmessage</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 处理数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;message&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 处理数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>服务数据可能是文本也可能是二进制数据:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmessage</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">===</span><span class="token plain"> </span><span class="token known-class-name class-name">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Received data string&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">instanceof</span><span class="token plain"> </span><span class="token class-name">ArrayBuffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> buffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Received arraybuffer&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>除了动态判断, 也可以使用<code>binaryType</code>属性来显示指定收到的二进制数据类型:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 收到的是 blob 数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">binaryType</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;blob&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmessage</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 收到的是 ArrayBuffer 数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">binaryType</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;arraybuffer&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onmessage</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">byteLength</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="常量">常量<a class="hash-link" href="#常量" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="ready-state-常量">Ready state 常量<a class="hash-link" href="#ready-state-常量" title="标题的直接链接">​</a></h4><p>这些常量是<code>readyState</code>属性的取值, 可以用来描述WebSocket连接的状态. </p><table><thead><tr><th>常量</th><th>值</th><th>描述</th></tr></thead><tbody><tr><td>CONNECTING</td><td>0</td><td>连接还没开启。</td></tr><tr><td>OPEN</td><td>1</td><td>连接已开启并准备好进行通信。</td></tr><tr><td>CLOSING</td><td>2</td><td>连接正在关闭的过程中。</td></tr><tr><td>CLOSED</td><td>3</td><td>连接已经关闭，或者连接无法建立。</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="方法">方法<a class="hash-link" href="#方法" title="标题的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="close">close()<a class="hash-link" href="#close" title="标题的直接链接">​</a></h4><p>关闭WebSocket连接或停止正在进行的连接请求. 如果连接的状态已经是<code>closed</code>, 这个方法不会有任何效果. </p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> optional unsigned short code</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> optional </span><span class="token maybe-class-name">DOMString</span><span class="token plain"> reason</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>参数:</p><ul><li>code: 可选, 一个数字, 表示关闭连接的状态好, 表示连接被关闭的原因. 如果这个参数没有被指定, 默认为1000</li><li>reason: 可选, 表示被关闭的原因, 必须是不超过123字节的UTF8文本, 可能抛出的异常:<ul><li>INVALID_ACCESS_ERR: 选定了无效的code</li><li>SYNTAX_ERR: reason字符串太长或者含有<code>unpaired surrogates</code></li></ul></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="send">send()<a class="hash-link" href="#send" title="标题的直接链接">​</a></h4><p>通过WebSocket连接向服务器发送数据:</p><div class="language-js codeBlockContainer_x9vG theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_XBdA"><pre tabindex="0" class="prism-code language-js codeBlock_E3X_ thin-scrollbar"><code class="codeBlockLines_WzRP"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token maybe-class-name">DOMString</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token known-class-name class-name">ArrayBuffer</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token maybe-class-name">Blob</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 发送string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;your message&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 发送Blob</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> file </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">querySelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;input[type=&quot;file&quot;]&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">files</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 发送ArrayBuffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> img </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> canvas_context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getImageData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">400</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">320</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> binary </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Uint8Array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  binary</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> img</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ws</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">binary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">buffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup_JJJj"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_lfBc" aria-hidden="true"><svg class="copyButtonIcon_fJbv" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YUzz" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>data: 发送到服务器的数据</p><p>可能抛出的异常:</p><ul><li>INVALID_STATE_ERR: 当前的连接状态不是OPEN</li><li>SYNTAX_ERR: 数据是一个包含<code>unpaired surrogates</code>的字符串</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="服务端api">服务端API<a class="hash-link" href="#服务端api" title="标题的直接链接">​</a></h2><p>常用的node实现有以下三种:</p><ul><li><a href="http://socket.io/" target="_blank" rel="noopener noreferrer">socket.io</a></li><li><a href="https://github.com/uNetworking/uWebSockets" target="_blank" rel="noopener noreferrer">uWebSocket</a></li><li><a href="https://github.com/theturtle32/WebSocket-Node" target="_blank" rel="noopener noreferrer">WebSocket-Node</a></li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="常见问题">常见问题<a class="hash-link" href="#常见问题" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="和tcp-http协议的关系">和TCP, HTTP协议的关系<a class="hash-link" href="#和tcp-http协议的关系" title="标题的直接链接">​</a></h3><p>WebSocket是基于TCP的独立的协议, 它的握手时有HTTP服务器解释为一个Upgrade请求.</p><p>WebSocket试图在现有的HTTP基础上下文中解决双向通信技术, 并且被设计工作在80和443端口, 支持HTTP代理和中间件.</p><h3 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="数据掩码的作用">数据掩码的作用<a class="hash-link" href="#数据掩码的作用" title="标题的直接链接">​</a></h3><p>数据掩码可以增强协议的安全性. 但数据掩码并不是为了保护数据本身而是为了防止早起版本的协议中存在的<code>代理缓存污染攻击</code>等问题. </p><h2 class="anchor anchorWithHideOnScrollNavbar_rm2F" id="参考链接">参考链接<a class="hash-link" href="#参考链接" title="标题的直接链接">​</a></h2><ul><li><a href="https://github.com/Pines-Cheng/blog/issues/37" target="_blank" rel="noopener noreferrer">WebSocket 详解</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/计算机网络/TCP&amp;UDP"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">TCP&amp;UDP</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/计算机网络/上传与下载"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">上传与下载</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_a_w_ thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#其他轮询方式" class="table-of-contents__link toc-highlight">其他轮询方式</a><ul><li><a href="#传统轮询" class="table-of-contents__link toc-highlight">传统轮询</a></li><li><a href="#长轮询" class="table-of-contents__link toc-highlight">长轮询</a></li><li><a href="#服务器发送事件server-sent-event" class="table-of-contents__link toc-highlight">服务器发送事件(Server-Sent Event)</a></li></ul></li><li><a href="#websocket简介" class="table-of-contents__link toc-highlight">WebSocket简介</a></li><li><a href="#协议介绍" class="table-of-contents__link toc-highlight">协议介绍</a><ul><li><a href="#协议概述" class="table-of-contents__link toc-highlight">协议概述</a></li><li><a href="#握手" class="table-of-contents__link toc-highlight">握手</a></li><li><a href="#数据帧" class="table-of-contents__link toc-highlight">数据帧</a></li><li><a href="#数据传递" class="table-of-contents__link toc-highlight">数据传递</a></li><li><a href="#关闭连接" class="table-of-contents__link toc-highlight">关闭连接</a></li><li><a href="#状态码" class="table-of-contents__link toc-highlight">状态码</a></li></ul></li><li><a href="#客户端api" class="table-of-contents__link toc-highlight">客户端API</a><ul><li><a href="#常量" class="table-of-contents__link toc-highlight">常量</a></li><li><a href="#方法" class="table-of-contents__link toc-highlight">方法</a></li></ul></li><li><a href="#服务端api" class="table-of-contents__link toc-highlight">服务端API</a></li><li><a href="#常见问题" class="table-of-contents__link toc-highlight">常见问题</a><ul><li><a href="#和tcp-http协议的关系" class="table-of-contents__link toc-highlight">和TCP, HTTP协议的关系</a></li><li><a href="#数据掩码的作用" class="table-of-contents__link toc-highlight">数据掩码的作用</a></li></ul></li><li><a href="#参考链接" class="table-of-contents__link toc-highlight">参考链接</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Wiki doc, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0fe2848a.js"></script>
<script src="/assets/js/main.755b20c3.js"></script>
</body>
</html>