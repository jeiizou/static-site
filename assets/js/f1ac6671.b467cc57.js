"use strict";(self.webpackChunkwiki_site=self.webpackChunkwiki_site||[]).push([[1128],{50158:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>m});var r=t(46393);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var u=r.createContext({}),l=function(e){var n=r.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},c=function(e){var n=l(e.components);return r.createElement(u.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},p=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,a=e.originalType,u=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),p=l(t),m=o,f=p["".concat(u,".").concat(m)]||p[m]||d[m]||a;return t?r.createElement(f,i(i({ref:n},c),{},{components:t})):r.createElement(f,i({ref:n},c))}));function m(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var a=t.length,i=new Array(a);i[0]=p;var s={};for(var u in n)hasOwnProperty.call(n,u)&&(s[u]=n[u]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var l=2;l<a;l++)i[l]=t[l];return r.createElement.apply(null,i)}return r.createElement.apply(null,t)}p.displayName="MDXCreateElement"},47802:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>l});var r=t(39421),o=(t(46393),t(50158));const a={},i="Vue-Router\u6e90\u7801\u89e3\u6790",s={unversionedId:"\u524d\u7aef\u8fdb\u9636/\u524d\u7aef\u6846\u67b6/VUE/Vue-Router\u6e90\u7801\u89e3\u6790",id:"\u524d\u7aef\u8fdb\u9636/\u524d\u7aef\u6846\u67b6/VUE/Vue-Router\u6e90\u7801\u89e3\u6790",title:"Vue-Router\u6e90\u7801\u89e3\u6790",description:"\u8def\u7531\u7684\u5b9e\u73b0\u539f\u7406",source:"@site/docs/02-\u524d\u7aef\u8fdb\u9636/\u524d\u7aef\u6846\u67b6/VUE/Vue-Router\u6e90\u7801\u89e3\u6790.md",sourceDirName:"02-\u524d\u7aef\u8fdb\u9636/\u524d\u7aef\u6846\u67b6/VUE",slug:"/\u524d\u7aef\u8fdb\u9636/\u524d\u7aef\u6846\u67b6/VUE/Vue-Router\u6e90\u7801\u89e3\u6790",permalink:"/docs/\u524d\u7aef\u8fdb\u9636/\u524d\u7aef\u6846\u67b6/VUE/Vue-Router\u6e90\u7801\u89e3\u6790",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Vue-Compiler",permalink:"/docs/\u524d\u7aef\u8fdb\u9636/\u524d\u7aef\u6846\u67b6/VUE/Vue-Compiler"},next:{title:"Vue-\u53cc\u5411\u7ed1\u5b9a",permalink:"/docs/\u524d\u7aef\u8fdb\u9636/\u524d\u7aef\u6846\u67b6/VUE/Vue-\u53cc\u5411\u7ed1\u5b9a"}},u={},l=[{value:"\u8def\u7531\u7684\u5b9e\u73b0\u539f\u7406",id:"\u8def\u7531\u7684\u5b9e\u73b0\u539f\u7406",level:2},{value:"\u8def\u7531\u5bf9\u8c61\u7684\u521b\u5efa",id:"\u8def\u7531\u5bf9\u8c61\u7684\u521b\u5efa",level:3},{value:"\u8def\u7531\u7684\u5b89\u88c5",id:"\u8def\u7531\u7684\u5b89\u88c5",level:3},{value:"\u8def\u5f84\u7684\u7ba1\u7406",id:"\u8def\u5f84\u7684\u7ba1\u7406",level:3},{value:"\u8def\u5f84\u548c\u8def\u7531\u7ec4\u4ef6\u7684\u6620\u5c04",id:"\u8def\u5f84\u548c\u8def\u7531\u7ec4\u4ef6\u7684\u6620\u5c04",level:2},{value:"\u5bfc\u822a\u5b88\u536b",id:"\u5bfc\u822a\u5b88\u536b",level:2}],c={toc:l};function d(e){let{components:n,...t}=e;return(0,o.kt)("wrapper",(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"vue-router\u6e90\u7801\u89e3\u6790"},"Vue-Router\u6e90\u7801\u89e3\u6790"),(0,o.kt)("h2",{id:"\u8def\u7531\u7684\u5b9e\u73b0\u539f\u7406"},"\u8def\u7531\u7684\u5b9e\u73b0\u539f\u7406"),(0,o.kt)("h3",{id:"\u8def\u7531\u5bf9\u8c61\u7684\u521b\u5efa"},"\u8def\u7531\u5bf9\u8c61\u7684\u521b\u5efa"),(0,o.kt)("p",null,"vue router \u63d0\u4f9b\u4e86\u4e00\u4e2acreateRouterApi, \u53ef\u4ee5\u7528\u4ed6\u6765\u521b\u5efa\u4e00\u4e2a\u8def\u7531\u5bf9\u8c61. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function createRouter(options) {\n  // \u5b9a\u4e49\u4e00\u4e9b\u8f85\u52a9\u65b9\u6cd5\u548c\u53d8\u91cf \n  \n  // ...\n  \n  // \u521b\u5efa router \u5bf9\u8c61\n  const router = {\n    // \u5f53\u524d\u8def\u5f84\n    currentRoute,\n    addRoute,\n    removeRoute,\n    hasRoute,\n    getRoutes,\n    resolve,\n    options,\n    push,\n    replace,\n    go,\n    back: () => go(-1),\n    forward: () => go(1),\n    beforeEach: beforeGuards.add,\n    beforeResolve: beforeResolveGuards.add,\n    afterEach: afterGuards.add,\n    onError: errorHandlers.add,\n    isReady,\n    install(app) {\n      // \u5b89\u88c5\u8def\u7531\u51fd\u6570\n    }\n  }\n  return router\n}\n")),(0,o.kt)("p",null,"\u8fd9\u91cc\u7701\u7565\u7684\u5927\u90e8\u5206\u7684\u4ee3\u7801, \u53ef\u4ee5\u770b\u5230\u8def\u7531router\u5c31\u662f\u4e00\u4e2a\u5bf9\u8c61, \u5b83\u59d4\u4f1a\u4e86\u5f53\u524d\u8def\u5f84currentRoute, \u5e76\u4e14\u62e5\u6709\u5f88\u591a\u8f85\u52a9\u65b9\u6cd5. "),(0,o.kt)("h3",{id:"\u8def\u7531\u7684\u5b89\u88c5"},"\u8def\u7531\u7684\u5b89\u88c5"),(0,o.kt)("p",null,"\u5f53\u6267\u884capp.use\u7684\u65f6\u5019, \u5c31\u662f\u5728\u6267\u884c",(0,o.kt)("inlineCode",{parentName:"p"},"router.install"),"\u65b9\u6cd5\u6765\u5b89\u88c5\u8def\u7531:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const router = {\n  install(app) {\n    const router = this\n    // \u6ce8\u518c\u8def\u7531\u7ec4\u4ef6\n    app.component('RouterLink', RouterLink)\n    app.component('RouterView', RouterView)\n    // \u5168\u5c40\u914d\u7f6e\u5b9a\u4e49 $router \u548c $route\n    app.config.globalProperties.$router = router\n    Object.defineProperty(app.config.globalProperties, '$route', {\n      get: () => unref(currentRoute),\n    })\n    // \u5728\u6d4f\u89c8\u5668\u7aef\u521d\u59cb\u5316\u5bfc\u822a\n    if (isBrowser &&\n      !started &&\n      currentRoute.value === START_LOCATION_NORMALIZED) {\n      // see above\n      started = true\n      push(routerHistory.location).catch(err => {\n        warn('Unexpected error when starting the router:', err)\n      })\n    }\n    // \u8def\u5f84\u53d8\u6210\u54cd\u5e94\u5f0f\n    const reactiveRoute = {}\n    for (let key in START_LOCATION_NORMALIZED) {\n      reactiveRoute[key] = computed(() => currentRoute.value[key])\n    }\n    // \u5168\u5c40\u6ce8\u5165 router \u548c reactiveRoute\n    app.provide(routerKey, router)\n    app.provide(routeLocationKey, reactive(reactiveRoute))\n    let unmountApp = app.unmount\n    installedApps.add(app)\n    // \u5e94\u7528\u5378\u8f7d\u7684\u65f6\u5019\uff0c\u9700\u8981\u505a\u4e00\u4e9b\u8def\u7531\u6e05\u7406\u5de5\u4f5c\n    app.unmount = function () {\n      installedApps.delete(app)\n      if (installedApps.size < 1) {\n        removeHistoryListener()\n        currentRoute.value = START_LOCATION_NORMALIZED\n        started = false\n        ready = false\n      }\n      unmountApp.call(this, arguments)\n    }\n  }\n}\n")),(0,o.kt)("p",null,"\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u6211\u4eec\u4e3b\u8981\u5173\u6ce8\u4e24\u4ef6\u4e8b:"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"\u5168\u5c40\u6ce8\u518c\u4e86RouterView\u548cRouterLink\u7ec4\u4ef6."),(0,o.kt)("li",{parentName:"ol"},"\u901a\u8fc7provider\u65b9\u5f0f\u5168\u5c40\u6ce8\u5165\u4e86router\u5bf9\u8c61\u548creactiveRoute\u5bf9\u8c61, \u5176\u4e2drouter\u8868\u793a\u7528\u6237\u901a\u8fc7creareRouter\u521b\u5efa\u7684\u8def\u7531\u5bf9\u8c61, \u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5b83\u53bb\u52a8\u6001\u7684\u64cd\u4f5c\u8def\u7531, reactiveRoute\u8868\u793a\u54cd\u5e94\u5f0f\u7684\u8def\u5f84\u5bf9\u8c61, \u5b83\u7ef4\u62a4\u4e86\u8def\u5f84\u76f8\u5173\u4fe1\u606f.")),(0,o.kt)("p",null,"\u4e0b\u9762\u7684\u95ee\u9898\u5c31\u53ea\u5269\u4e0b\u4e86: \u8def\u5f84\u662f\u5982\u4f55\u7ba1\u7406\u7684, \u8def\u5f84\u548c\u8def\u7531\u7ec4\u4ef6\u7684\u6e32\u67d3\u662f\u5982\u4f55\u6620\u5c04\u7684/"),(0,o.kt)("h3",{id:"\u8def\u5f84\u7684\u7ba1\u7406"},"\u8def\u5f84\u7684\u7ba1\u7406"),(0,o.kt)("p",null,"\u8def\u7531\u7684\u57fa\u7840\u7ed3\u6784\u5c31\u662f\u4e00\u4e2a\u8def\u5f84\u5bf9\u5e94\u4e00\u79cd\u89c6\u56fe, \u5f53\u6211\u4eec\u5207\u6362\u8def\u5f84\u7684\u65f6\u5019\u5bf9\u5e94\u7684\u89c6\u56fe\u4e5f\u4f1a\u5207\u6362, \u56e0\u6b64\u8def\u5f84\u7684\u7ba1\u7406\u5c31\u5c24\u4e3a\u91cd\u8981."),(0,o.kt)("p",null,"\u9996\u5148\u6211\u4eec\u9700\u8981\u7ef4\u62a4\u5f53\u524d\u7684\u8def\u5f84currentRoute, \u53ef\u4ee5\u7ed9\u4ed6\u4e00\u4e2a\u521d\u59cb\u503c",(0,o.kt)("inlineCode",{parentName:"p"},"START_LOCATION_NORMALIZED"),", \u5982\u4e0b:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const START_LOCATION_NORMALIZED = {\n  path: '/',\n  name: undefined,\n  params: {},\n  query: {},\n  hash: '',\n  fullPath: '/',\n  matched: [],\n  meta: {},\n  redirectedFrom: undefined\n}\n")),(0,o.kt)("p",null,"\u8def\u7531\u53d1\u751f\u53d8\u5316, \u5c31\u662f\u901a\u8fc7\u6539\u53d8\u8def\u5f84\u5b8c\u6210\u7684, \u8def\u7531\u5bf9\u8c61\u63d0\u4f9b\u4e86\u5f88\u591a\u6539\u53d8\u8def\u5f84\u7684\u65b9\u6cd5, \u6bd4\u5982",(0,o.kt)("inlineCode",{parentName:"p"},"router.push"),"\u7b49\u7b49, \u5e95\u5c42\u90fd\u662f\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"p"},"pushWithRedirect"),"\u5b8c\u6210\u8def\u5f84\u7684\u5207\u6362, \u5176\u5b9e\u73b0\u5982\u4e0b:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function pushWithRedirect(to, redirectedFrom) {\n  const targetLocation = (pendingLocation = resolve(to))\n  const from = currentRoute.value\n  const data = to.state\n  const force = to.force\n  const replace = to.replace === true\n  const toLocation = targetLocation\n  toLocation.redirectedFrom = redirectedFrom\n  let failure\n  if (!force && isSameRouteLocation(stringifyQuery$1, from, targetLocation)) {\n    failure = createRouterError(16 /* NAVIGATION_DUPLICATED */, { to: toLocation, from })\n    handleScroll(from, from, true, false)\n  }\n  return (failure ? Promise.resolve(failure) : navigate(toLocation, from))\n    .catch((error) => {\n      if (isNavigationFailure(error, 4 /* NAVIGATION_ABORTED */ |\n        8 /* NAVIGATION_CANCELLED */ |\n        2 /* NAVIGATION_GUARD_REDIRECT */)) {\n        return error\n      }\n      return triggerError(error)\n    })\n    .then((failure) => {\n      if (failure) {\n        // \u5904\u7406\u9519\u8bef\n      }\n      else {\n        failure = finalizeNavigation(toLocation, from, true, replace, data)\n      }\n      triggerAfterEach(toLocation, from, failure)\n      return failure\n    })\n}\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"pushWithRedirect"),"\u7684\u6838\u5fc3\u601d\u8def, \u9996\u5148to\u53ef\u80fd\u6709\u591a\u79cd\u60c5\u51b5, \u53ef\u4ee5\u662f\u4e00\u4e2a\u5b57\u7b26\u4e32, \u4e5f\u53ef\u4ee5\u662f\u4e00\u4e2a\u8def\u5f84\u5bf9\u8c61, \u6240\u4ee5\u8981\u5148\u7ecf\u8fc7\u4e00\u5c42resolve\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684\u8def\u5f84\u5bf9\u8c61, \u4f1a\u591a\u4e00\u4e2amatched\u5c5e\u6027."),(0,o.kt)("p",null,"\u5f97\u5230\u65b0\u7684\u76ee\u6807\u8def\u5f84\u540e, \u63a5\u4e0b\u6765\u6267\u884cnavigate\u65b9\u6cd5, \u5b9e\u9645\u4e0a\u662f\u6267\u884c\u7559\u6709\u5207\u6362\u8fc7\u7a0b\u4e2d\u7684\u4e00\u7cfb\u5217\u5bfc\u822a\u5b88\u536b\u51fd\u6570, navigate\u6210\u529f\u540e, \u4f1a\u6267\u884c",(0,o.kt)("inlineCode",{parentName:"p"},"finalizeNavigation"),"\u65b9\u6cd5\u5b8c\u6210\u5bfc\u822a. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function finalizeNavigation(toLocation, from, isPush, replace, data) {\n  const error = checkCanceledNavigation(toLocation, from)\n  if (error)\n    return error\n  const isFirstNavigation = from === START_LOCATION_NORMALIZED\n  const state = !isBrowser ? {} : history.state\n  if (isPush) {\n    if (replace || isFirstNavigation)\n      routerHistory.replace(toLocation.fullPath, assign({\n        scroll: isFirstNavigation && state && state.scroll,\n      }, data))\n    else\n      routerHistory.push(toLocation.fullPath, data)\n  }\n  currentRoute.value = toLocation\n  handleScroll(toLocation, from, isPush, isFirstNavigation)\n  markAsReady()\n}\n")),(0,o.kt)("p",null,"\u8fd9\u91cc\u6709\u4e24\u4e2a\u91cd\u70b9\u903b\u8f91:"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"\u66f4\u65b0\u5f53\u524d\u7684\u8def\u5f84currentRoute\u503c"),(0,o.kt)("li",{parentName:"ul"},"\u6267\u884crouterHistory.push\u6216\u8005routerHistory.replace\u65b9\u6cd5\u66f4\u65b0\u6d4f\u89c8\u5668\u7684URL\u8bb0\u5f55")),(0,o.kt)("p",null,"\u5f53\u6211\u4eec\u5207\u6362\u8def\u7531\u7684\u65f6\u5019, \u4f60\u5c31\u4f1a\u53d1\u73b0URL\u53d1\u751f\u4e86\u53d8\u5316, \u4f46\u662f\u9875\u9762\u6ca1\u6709\u5237\u65b0, \u662f\u5e94\u4e3a\u501f\u52a9\u4e86H5\u7684historyAPI"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function createWebHistory(base) {\n  base = normalizeBase(base)\n  const historyNavigation = useHistoryStateNavigation(base)\n  const historyListeners = useHistoryListeners(base, historyNavigation.state, historyNavigation.location, historyNavigation.replace)\n  function go(delta, triggerListeners = true) {\n    if (!triggerListeners)\n      historyListeners.pauseListeners()\n    history.go(delta)\n  }\n  const routerHistory = assign({\n    // it's overridden right after\n    location: '',\n    base,\n    go,\n    createHref: createHref.bind(null, base),\n  }, historyNavigation, historyListeners)\n  Object.defineProperty(routerHistory, 'location', {\n    get: () => historyNavigation.location.value,\n  })\n  Object.defineProperty(routerHistory, 'state', {\n    get: () => historyNavigation.state.value,\n  })\n  return routerHistory\n}\n")),(0,o.kt)("p",null,"routerHistory\u7684\u4f5c\u7528\u4e00\u4e2a\u662f\u8def\u5f84\u7684\u5207\u6362, \u4e00\u4e2a\u662f\u76d1\u542c\u8def\u5f84\u7684\u53d8\u5316. "),(0,o.kt)("p",null,"\u5176\u4e2d\u8def\u5f84\u5207\u6362\u4e3b\u8981\u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"p"},"historyNavigation"),"\u6765\u5b8c\u6210\u7684, \u5b83\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"useHistoryStateNavigation"),"\u51fd\u6570\u7684\u8fd4\u56de\u503c:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function useHistoryStateNavigation(base) {\n  const { history, location } = window\n  let currentLocation = {\n    value: createCurrentLocation(base, location),\n  }\n  let historyState = { value: history.state }\n  if (!historyState.value) {\n    changeLocation(currentLocation.value, {\n      back: null,\n      current: currentLocation.value,\n      forward: null,\n      position: history.length - 1,\n      replaced: true,\n      scroll: null,\n    }, true)\n  }\n  function changeLocation(to, state, replace) {\n    const url = createBaseLocation() +\n      // preserve any existing query when base has a hash\n      (base.indexOf('#') > -1 && location.search\n        ? location.pathname + location.search + '#'\n        : base) +\n      to\n    try {\n      history[replace ? 'replaceState' : 'pushState'](state, '', url)\n      historyState.value = state\n    }\n    catch (err) {\n      warn('Error with push/replace State', err)\n      location[replace ? 'replace' : 'assign'](url)\n    }\n  }\n  function replace(to, data) {\n    const state = assign({}, history.state, buildState(historyState.value.back,\n      // keep back and forward entries but override current position\n      to, historyState.value.forward, true), data, { position: historyState.value.position })\n    changeLocation(to, state, true)\n    currentLocation.value = to\n  }\n  function push(to, data) {\n    const currentState = assign({},\n      historyState.value, history.state, {\n        forward: to,\n        scroll: computeScrollPosition(),\n      })\n    if ( !history.state) {\n      warn(`history.state seems to have been manually replaced without preserving the necessary values. Make sure to preserve existing history state if you are manually calling history.replaceState:\\n\\n` +\n        `history.replaceState(history.state, '', url)\\n\\n` +\n        `You can find more information at https://next.router.vuejs.org/guide/migration/#usage-of-history-state.`)\n    }\n    changeLocation(currentState.current, currentState, true)\n    const state = assign({}, buildState(currentLocation.value, to, null), { position: currentState.position + 1 }, data)\n    changeLocation(to, state, false)\n    currentLocation.value = to\n  }\n  return {\n    location: currentLocation,\n    state: historyState,\n    push,\n    replace\n  }\n}\n")),(0,o.kt)("p",null,"\u8be5\u51fd\u6570\u8fd4\u56de\u7684push\u548creplace\u51fd\u6570, \u4f1a\u6dfb\u52a0\u7ed9routerHistory\u5bf9\u8c61\u4e0a, \u56e0\u6b64\u5f53\u6211\u4eec\u8c03\u7528routerHistory.push\u6216\u8005routerHistory.replace\u65b9\u6cd5\u7684\u65f6\u5019\u5c31\u662f\u5728\u6267\u884c\u8fd9\u4e24\u4e2a\u51fd\u6570."),(0,o.kt)("p",null,"push\u548creplace\u65b9\u6cd5\u5185\u90e8\u90fd\u662f\u6267\u884c\u4e86changeLoaction\u65b9\u6cd5, \u8be5\u51fd\u6570\u5185\u90e8\u6267\u884c\u4e86\u6d4f\u89c8\u5668\u7684history.pushState/histpry.replaceState\u65b9\u6cd5, \u4f1a\u60f3\u5f53\u524d\u6d4f\u89c8\u5668\u7ed8\u753b\u7684\u5386\u53f2\u5806\u6808\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u72b6\u6001. "),(0,o.kt)("p",null,"\u6b64\u5916\u6211\u4eec\u8fd8\u9700\u8981\u76d1\u542c\u6d4f\u89c8\u5668\u7684\u56de\u9000\u4e8b\u4ef6:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function useHistoryListeners(base, historyState, currentLocation, replace) {\n  let listeners = []\n  let teardowns = []\n  let pauseState = null\n  const popStateHandler = ({ state, }) => {\n    const to = createCurrentLocation(base, location)\n    const from = currentLocation.value\n    const fromState = historyState.value\n    let delta = 0\n    if (state) {\n      currentLocation.value = to\n      historyState.value = state\n      if (pauseState && pauseState === from) {\n        pauseState = null\n        return\n      }\n      delta = fromState ? state.position - fromState.position : 0\n    }\n    else {\n      replace(to)\n    }\n    listeners.forEach(listener => {\n      listener(currentLocation.value, from, {\n        delta,\n        type: NavigationType.pop,\n        direction: delta\n          ? delta > 0\n            ? NavigationDirection.forward\n            : NavigationDirection.back\n          : NavigationDirection.unknown,\n      })\n    })\n  }\n  function pauseListeners() {\n    pauseState = currentLocation.value\n  }\n  function listen(callback) {\n    listeners.push(callback)\n    const teardown = () => {\n      const index = listeners.indexOf(callback)\n      if (index > -1)\n        listeners.splice(index, 1)\n    }\n    teardowns.push(teardown)\n    return teardown\n  }\n  function beforeUnloadListener() {\n    const { history } = window\n    if (!history.state)\n      return\n    history.replaceState(assign({}, history.state, { scroll: computeScrollPosition() }), '')\n  }\n  function destroy() {\n    for (const teardown of teardowns)\n      teardown()\n    teardowns = []\n    window.removeEventListener('popstate', popStateHandler)\n    window.removeEventListener('beforeunload', beforeUnloadListener)\n  }\n  window.addEventListener('popstate', popStateHandler)\n  window.addEventListener('beforeunload', beforeUnloadListener)\n  return {\n    pauseListeners,\n    listen,\n    destroy\n  }\n}\n")),(0,o.kt)("p",null,"\u8be5\u51fd\u6570\u8fd4\u56de\u4e86listen\u65b9\u6cd5, \u5141\u8bb8\u6dfb\u52a0\u4e00\u4e9b\u4fa6\u542c\u5668, \u4fa6\u542chistory\u7684\u53d8\u5316, \u540c\u65f6\u8be5\u65b9\u6cd5\u4e5f\u88ab\u6302\u8f7d\u5230\u4e86routerHistory\u5bf9\u8c61\u4e0a, \u8fd9\u6837\u5916\u90e8\u90a3\u5c31\u53ef\u4ee5\u8bbf\u95ee\u5230\u4e86. "),(0,o.kt)("p",null,"\u8fd8\u51fd\u6570\u5185\u90e8\u8fd8\u76d1\u542c\u4e86\u6d4f\u89c8\u5668\u5e95\u5c42\u7684window.popstate\u4e8b\u4ef6, \u5f53\u6211\u4eec\u70b9\u51fb\u6d4f\u89c8\u5668\u7684\u56de\u9000\u6216\u8005\u6267\u884cback\u65b9\u6cd5\u7684\u65f6\u5019, \u4f1a\u89e6\u53d1\u4e8b\u4ef6\u7684\u56de\u8c03\u51fd\u6570popStateHandler, \u8fdb\u800c\u904d\u5386\u771f\u9898\u5668listeners, \u6267\u884c\u6bcf\u4e00\u4e2a\u4fa6\u542c\u5668\u51fd\u6570. "),(0,o.kt)("p",null,"\u8fd9\u4e9b\u4fa6\u542c\u5668\u5728\u5b89\u88c5\u8def\u7531\u7684\u65f6\u5019, \u4f1a\u6267\u884c\u4e00\u6b21\u521d\u59cb\u5316\u5bfc\u822a, \u901a\u8fc7",(0,o.kt)("inlineCode",{parentName:"p"},"push->finalizeNavigation->markAsReady"),"\u65b9\u6cd5\u8fdb\u884c\u589e\u52a0:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function markAsReady(err) {\n  if (ready)\n    return\n  ready = true\n  setupListeners()\n  readyHandlers\n    .list()\n    .forEach(([resolve, reject]) => (err ? reject(err) : resolve()))\n  readyHandlers.reset()\n}\n")),(0,o.kt)("p",null,"markAsReady \u5185\u90e8\u4f1a\u6267\u884c setupListeners \u51fd\u6570\u521d\u59cb\u5316\u4fa6\u542c\u5668\uff0c\u4e14\u4fdd\u8bc1\u53ea\u521d\u59cb\u5316\u4e00\u6b21:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function setupListeners() {\n  removeHistoryListener = routerHistory.listen((to, _from, info) => {\n    const toLocation = resolve(to)\n    pendingLocation = toLocation\n    const from = currentRoute.value\n    if (isBrowser) {\n      saveScrollPosition(getScrollKey(from.fullPath, info.delta), computeScrollPosition())\n    }\n    navigate(toLocation, from)\n      .catch((error) => {\n        if (isNavigationFailure(error, 4 /* NAVIGATION_ABORTED */ | 8 /* NAVIGATION_CANCELLED */)) {\n          return error\n        }\n        if (isNavigationFailure(error, 2 /* NAVIGATION_GUARD_REDIRECT */)) {\n          if (info.delta)\n            routerHistory.go(-info.delta, false)\n          pushWithRedirect(error.to, toLocation\n          ).catch(noop)\n          // avoid the then branch\n          return Promise.reject()\n        }\n        if (info.delta)\n          routerHistory.go(-info.delta, false)\n        return triggerError(error)\n      })\n      .then((failure) => {\n        failure =\n          failure ||\n          finalizeNavigation(\n            toLocation, from, false)\n        if (failure && info.delta)\n          routerHistory.go(-info.delta, false)\n        triggerAfterEach(toLocation, from, failure)\n      })\n      .catch(noop)\n  })\n}\n")),(0,o.kt)("p",null,"\u4fa6\u542c\u5668\u51fd\u6570\u4e5f\u662f\u6267\u884cnavigate\u65b9\u6cd5, \u6267\u884c\u8def\u7531\u5207\u6362\u8fc7\u7a0b\u4e2d\u7684\u4e00\u4e9b\u5217\u5bfc\u822a\u5b88\u536b\u51fd\u6570, \u5728navigate\u6210\u529f\u540e\u6267\u884cfinalizeNavigatetion\u5b8c\u6210\u5bfc\u822a, \u5b8c\u6210\u771f\u6b63\u7684\u8def\u5f84\u5207\u6362. \u8fd9\u6837\u5c31\u4fdd\u8bc1\u4e86\u56de\u9000\u7684\u65f6\u5019\u53ef\u4ee5\u6062\u590d\u5230\u4e0a\u4e00\u4e2a\u8def\u5f84\u4ee5\u53ca\u66f4\u65b0\u8def\u7531\u89c6\u56fe. "),(0,o.kt)("h2",{id:"\u8def\u5f84\u548c\u8def\u7531\u7ec4\u4ef6\u7684\u6620\u5c04"},"\u8def\u5f84\u548c\u8def\u7531\u7ec4\u4ef6\u7684\u6620\u5c04"),(0,o.kt)("p",null,"RouterView\u7684\u5b9e\u73b0\u5982\u4e0b:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const RouterView = defineComponent({\n  name: 'RouterView',\n  props: {\n    name: {\n      type: String,\n      default: 'default',\n    },\n    route: Object,\n  },\n  setup(props, { attrs, slots }) {\n    warnDeprecatedUsage()\n    const injectedRoute = inject(routeLocationKey)\n    const depth = inject(viewDepthKey, 0)\n    const matchedRouteRef = computed(() => (props.route || injectedRoute).matched[depth])\n    provide(viewDepthKey, depth + 1)\n    provide(matchedRouteKey, matchedRouteRef)\n    const viewRef = ref()\n    watch(() => [viewRef.value, matchedRouteRef.value, props.name], ([instance, to, name], [oldInstance, from, oldName]) => {\n      if (to) {\n        to.instances[name] = instance\n        if (from && instance === oldInstance) {\n          to.leaveGuards = from.leaveGuards\n          to.updateGuards = from.updateGuards\n        }\n      }\n      if (instance &&\n        to &&\n        (!from || !isSameRouteRecord(to, from) || !oldInstance)) {\n        (to.enterCallbacks[name] || []).forEach(callback => callback(instance))\n      }\n    })\n    return () => {\n      const route = props.route || injectedRoute\n      const matchedRoute = matchedRouteRef.value\n      const ViewComponent = matchedRoute && matchedRoute.components[props.name]\n      const currentName = props.name\n      if (!ViewComponent) {\n        return slots.default\n          ? slots.default({ Component: ViewComponent, route })\n          : null\n      }\n      const routePropsOption = matchedRoute.props[props.name]\n      const routeProps = routePropsOption\n        ? routePropsOption === true\n          ? route.params\n          : typeof routePropsOption === 'function'\n            ? routePropsOption(route)\n            : routePropsOption\n        : null\n      const onVnodeUnmounted = vnode => {\n        if (vnode.component.isUnmounted) {\n          matchedRoute.instances[currentName] = null\n        }\n      }\n      const component = h(ViewComponent, assign({}, routeProps, attrs, {\n        onVnodeUnmounted,\n        ref: viewRef,\n      }))\n      return (\n        slots.default\n          ? slots.default({ Component: component, route })\n          : component)\n    }\n  },\n})\n")),(0,o.kt)("p",null,"\u901a\u5e38\u88ab\u4e0d\u5e26\u63d2\u69fd\u7684\u60c5\u51b5\u4e0b, \u4f1a\u8fd4\u56decomponent\u53d8\u91cf, \u5b83\u662f\u6839\u636eViewComponent\u6e32\u67d3\u51fa\u6765\u7684, \u800cViewComponent\u662f\u6839\u636e",(0,o.kt)("inlineCode",{parentName:"p"},"matchedRoute.components[props.name]"),"\u6c42\u5f97\u7684, \u800c",(0,o.kt)("inlineCode",{parentName:"p"},"matchedRoute"),"\u662f",(0,o.kt)("inlineCode",{parentName:"p"},"matchRouteRef"),"\u5bf9\u5e94\u7684value."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"matchedRouteRef"),"\u4e00\u4e2a\u8ba1\u7b97\u5c5e\u6027, \u5728\u4e0d\u8003\u8651prop\u4f20\u5165route\u7684\u60c5\u51b5\u4e0b, \u5b83\u7684getter\u662f\u7531",(0,o.kt)("inlineCode",{parentName:"p"},"injectedRoute.matched[depth]"),"\u6c42\u5f97\u7684, \u800c",(0,o.kt)("inlineCode",{parentName:"p"},"injectedRoute"),", \u5c31\u662f\u6211\u4eec\u5728\u524d\u9762\u5728\u5b89\u88c5\u8def\u7531\u7684\u65f6\u5019, \u6ce8\u5165\u7684\u54cd\u5e94\u5f0fcurrentRoute\u5bf9\u8c61. "),(0,o.kt)("p",null,"RouterView \u7684\u6e32\u67d3\u7684\u8def\u7531\u7ec4\u4ef6\u548c\u5f53\u524d\u8def\u5f84 currentRoute \u7684 matched \u5bf9\u8c61\u76f8\u5173\uff0c\u4e5f\u548c RouterView \u81ea\u8eab\u7684\u5d4c\u5957\u5c42\u7ea7\u76f8\u5173"),(0,o.kt)("p",null,"\u5f53\u6211\u4eec\u6267\u884c createRouter \u51fd\u6570\u521b\u5efa\u8def\u7531\u7684\u65f6\u5019\uff0c\u5185\u90e8\u4f1a\u6267\u884c\u5982\u4e0b\u4ee3\u7801\u6765\u521b\u5efa\u4e00\u4e2a matcher \u5bf9\u8c61\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"const matcher = createRouterMatcher(options.routes, options)\n")),(0,o.kt)("p",null,"\u6267\u884c\u4e86",(0,o.kt)("inlineCode",{parentName:"p"},"createRouterMatcher"),"\u51fd\u6570\uff0c\u5e76\u4f20\u5165 routes \u8def\u5f84\u914d\u7f6e\u6570\u7ec4\uff0c\u5b83\u7684\u76ee\u7684\u5c31\u662f\u6839\u636e\u8def\u5f84\u914d\u7f6e\u5bf9\u8c61\u521b\u5efa\u4e00\u4e2a\u8def\u7531\u7684\u5339\u914d\u5bf9\u8c61\uff0c\u518d\u6765\u770b\u5b83\u7684\u5b9e\u73b0\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function createRouterMatcher(routes, globalOptions) {\n  const matchers = []\n  const matcherMap = new Map()\n  globalOptions = mergeOptions({ strict: false, end: true, sensitive: false }, globalOptions)\n  \n  function addRoute(record, parent, originalRecord) {\n    let isRootAdd = !originalRecord\n    let mainNormalizedRecord = normalizeRouteRecord(record)\n    mainNormalizedRecord.aliasOf = originalRecord && originalRecord.record\n    const options = mergeOptions(globalOptions, record)\n    const normalizedRecords = [\n      mainNormalizedRecord,\n    ]\n    let matcher\n    let originalMatcher\n    for (const normalizedRecord of normalizedRecords) {\n      let { path } = normalizedRecord\n      if (parent && path[0] !== '/') {\n        let parentPath = parent.record.path\n        let connectingSlash = parentPath[parentPath.length - 1] === '/' ? '' : '/'\n        normalizedRecord.path =\n          parent.record.path + (path && connectingSlash + path)\n      }\n      matcher = createRouteRecordMatcher(normalizedRecord, parent, options)\n      if ( parent && path[0] === '/')\n        checkMissingParamsInAbsolutePath(matcher, parent)\n      if (originalRecord) {\n        originalRecord.alias.push(matcher)\n        {\n          checkSameParams(originalRecord, matcher)\n        }\n      }\n      else {\n        originalMatcher = originalMatcher || matcher\n        if (originalMatcher !== matcher)\n          originalMatcher.alias.push(matcher)\n        if (isRootAdd && record.name && !isAliasRecord(matcher))\n          removeRoute(record.name)\n      }\n      if ('children' in mainNormalizedRecord) {\n        let children = mainNormalizedRecord.children\n        for (let i = 0; i < children.length; i++) {\n          addRoute(children[i], matcher, originalRecord && originalRecord.children[i])\n        }\n      }\n      originalRecord = originalRecord || matcher\n      insertMatcher(matcher)\n    }\n    return originalMatcher\n      ? () => {\n        removeRoute(originalMatcher)\n      }\n      : noop\n  }\n  \n  function insertMatcher(matcher) {\n    let i = 0\n    while (i < matchers.length &&\n    comparePathParserScore(matcher, matchers[i]) >= 0)\n      i++\n    matchers.splice(i, 0, matcher)\n    if (matcher.record.name && !isAliasRecord(matcher))\n      matcherMap.set(matcher.record.name, matcher)\n  }\n \n  // \u5b9a\u4e49\u5176\u5b83\u4e00\u4e9b\u8f85\u52a9\u51fd\u6570\n  \n  // \u6dfb\u52a0\u521d\u59cb\u8def\u5f84\n  routes.forEach(route => addRoute(route))\n  return { addRoute, resolve, removeRoute, getRoutes, getRecordMatcher }\n}\n")),(0,o.kt)("p",null,"createRouterMatcher \u51fd\u6570\u5185\u90e8\u5b9a\u4e49\u4e86\u4e00\u4e2a matchers \u6570\u7ec4\u548c\u4e00\u4e9b\u8f85\u52a9\u51fd\u6570\uff0c\u6211\u4eec\u5148\u91cd\u70b9\u5173\u6ce8 addRoute \u51fd\u6570\u7684\u5b9e\u73b0\uff0c\u6211\u4eec\u53ea\u5173\u6ce8\u6838\u5fc3\u6d41\u7a0b"),(0,o.kt)("p",null,"\u5728 createRouterMatcher \u51fd\u6570\u7684\u6700\u540e\uff0c\u4f1a\u904d\u5386 routes \u8def\u5f84\u6570\u7ec4\u8c03\u7528 addRoute \u65b9\u6cd5\u6dfb\u52a0\u521d\u59cb\u8def\u5f84\u3002"),(0,o.kt)("p",null,"\u5728 addRoute \u51fd\u6570\u5185\u90e8\uff0c\u9996\u5148\u4f1a\u628a route \u5bf9\u8c61\u6807\u51c6\u5316\u6210\u4e00\u4e2a record\uff0c\u5176\u5b9e\u5c31\u662f\u7ed9\u8def\u5f84\u5bf9\u8c61\u6dfb\u52a0\u66f4\u4e30\u5bcc\u7684\u5c5e\u6027\u3002"),(0,o.kt)("p",null,"\u7136\u540e\u518d\u6267\u884ccreateRouteRecordMatcher \u51fd\u6570\uff0c\u4f20\u5165\u6807\u51c6\u5316\u7684 record \u5bf9\u8c61\uff0c\u6211\u4eec\u518d\u6765\u770b\u5b83\u7684\u5b9e\u73b0\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},'function createRouteRecordMatcher(record, parent, options) {\n  const parser = tokensToParser(tokenizePath(record.path), options)\n  {\n    const existingKeys = new Set()\n    for (const key of parser.keys) {\n      if (existingKeys.has(key.name))\n        warn(`Found duplicated params with name "${key.name}" for path "${record.path}". Only the last one will be available on "$route.params".`)\n      existingKeys.add(key.name)\n    }\n  }\n  const matcher = assign(parser, {\n    record,\n    parent,\n    children: [],\n    alias: []\n  })\n  if (parent) {\n    if (!matcher.record.aliasOf === !parent.record.aliasOf)\n      parent.children.push(matcher)\n  }\n  return matcher\n}\n')),(0,o.kt)("p",null,"resolve \u51fd\u6570\u4e3b\u8981\u505a\u7684\u4e8b\u60c5\u5c31\u662f\u6839\u636e location \u7684 name \u6216\u8005 path \u4ece\u6211\u4eec\u524d\u9762\u521b\u5efa\u7684 matchers \u6570\u7ec4\u4e2d\u627e\u5230\u5bf9\u5e94\u7684 matcher\uff0c\u7136\u540e\u518d\u987a\u7740 matcher \u7684 parent \u4e00\u76f4\u627e\u5230\u94fe\u8def\u4e0a\u6240\u6709\u5339\u914d\u7684 matcher\uff0c\u7136\u540e\u83b7\u53d6\u5176\u4e2d\u7684 record \u5c5e\u6027\u6784\u9020\u6210\u4e00\u4e2a matched \u6570\u7ec4\uff0c\u6700\u7ec8\u8fd4\u56de\u5305\u542b matched \u5c5e\u6027\u7684\u65b0\u7684\u8def\u5f84\u5bf9\u8c61\u3002"),(0,o.kt)("p",null,"\u8fd9\u4e48\u505a\u7684\u76ee\u7684\u5c31\u662f\u8ba9 matched \u6570\u7ec4\u5b8c\u6574\u8bb0\u5f55 record \u8def\u5f84\uff0c\u5b83\u7684\u987a\u5e8f\u548c\u5d4c\u5957\u7684 RouterView \u7ec4\u4ef6\u987a\u5e8f\u4e00\u81f4\uff0c\u4e5f\u5c31\u662f matched \u6570\u7ec4\u4e2d\u7684\u7b2c n \u4e2a\u5143\u7d20\u5c31\u4ee3\u8868\u7740 RouterView \u5d4c\u5957\u7684\u7b2c n \u5c42\u3002"),(0,o.kt)("p",null,"\u56e0\u6b64 targetLocation \u548c to \u76f8\u6bd4\uff0c\u5176\u5b9e\u5c31\u662f\u591a\u4e86\u4e00\u4e2a matched \u5bf9\u8c61\uff0c\u8fd9\u6837\u518d\u56de\u5230\u6211\u4eec\u7684 RouterView \u7ec4\u4ef6\uff0c\u5c31\u53ef\u4ee5\u4eceinjectedRoute.matched","[depth][props.name]","\u4e2d\u62ff\u5230\u5bf9\u5e94\u7684\u7ec4\u4ef6\u5bf9\u8c61\u5b9a\u4e49\uff0c\u53bb\u6e32\u67d3\u5bf9\u5e94\u7684\u7ec4\u4ef6\u4e86\u3002"),(0,o.kt)("p",null,"\u81f3\u6b64\uff0c\u6211\u4eec\u5c31\u641e\u6e05\u695a\u8def\u5f84\u548c\u8def\u7531\u7ec4\u4ef6\u7684\u6e32\u67d3\u662f\u5982\u4f55\u6620\u5c04\u7684\u4e86\u3002"),(0,o.kt)("p",null,"\u524d\u9762\u7684\u5206\u6790\u8fc7\u7a0b\u4e2d\uff0c\u6211\u4eec\u63d0\u5230\u8fc7\u5728\u8def\u5f84\u5207\u6362\u8fc7\u7a0b\u4e2d\uff0c\u4f1a\u6267\u884c navigate \u65b9\u6cd5\uff0c\u5b83\u5305\u542b\u4e86\u4e00\u7cfb\u5217\u7684\u5bfc\u822a\u5b88\u536b\u94a9\u5b50\u51fd\u6570\u7684\u6267\u884c\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u6765\u5206\u6790\u8fd9\u90e8\u5206\u7684\u5b9e\u73b0\u539f\u7406\u3002"),(0,o.kt)("h2",{id:"\u5bfc\u822a\u5b88\u536b"},"\u5bfc\u822a\u5b88\u536b"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"router.beforeEach((to, from, next) => {\n  if (to.name !== 'Login' && !isAuthenticated) next({ name: 'Login' }) else {\n    next()\n  }\n})\n")),(0,o.kt)("p",null,"\u8fd9\u91cc\u5927\u81f4\u542b\u4e49\u5c31\u662f\u8fdb\u5165\u8def\u7531\u524d\u68c0\u67e5\u7528\u6237\u662f\u5426\u767b\u5f55\uff0c\u5982\u679c\u6ca1\u6709\u5219\u8df3\u8f6c\u5230\u767b\u5f55\u7684\u89c6\u56fe\u7ec4\u4ef6\uff0c\u5426\u5219\u7ee7\u7eed\u3002"),(0,o.kt)("p",null,"router.beforeEach \u4f20\u5165\u7684\u53c2\u6570\u662f\u4e00\u4e2a\u51fd\u6570\uff0c\u6211\u4eec\u628a\u8fd9\u7c7b\u51fd\u6570\u5c31\u79f0\u4e3a\u5bfc\u822a\u5b88\u536b\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function navigate(to, from) {\n  let guards\n  const [leavingRecords, updatingRecords, enteringRecords,] = extractChangingRecords(to, from)\n  guards = extractComponentsGuards(leavingRecords.reverse(), 'beforeRouteLeave', to, from)\n  for (const record of leavingRecords) {\n    for (const guard of record.leaveGuards) {\n      guards.push(guardToPromiseFn(guard, to, from))\n    }\n  }\n  const canceledNavigationCheck = checkCanceledNavigationAndReject.bind(null, to, from)\n  guards.push(canceledNavigationCheck)\n  return (runGuardQueue(guards)\n    .then(() => {\n      guards = []\n      for (const guard of beforeGuards.list()) {\n        guards.push(guardToPromiseFn(guard, to, from))\n      }\n      guards.push(canceledNavigationCheck)\n      return runGuardQueue(guards)\n    })\n    .then(() => {\n      guards = extractComponentsGuards(updatingRecords, 'beforeRouteUpdate', to, from)\n      for (const record of updatingRecords) {\n        for (const guard of record.updateGuards) {\n          guards.push(guardToPromiseFn(guard, to, from))\n        }\n      }\n      guards.push(canceledNavigationCheck)\n      return runGuardQueue(guards)\n    })\n    .then(() => {\n      guards = []\n      for (const record of to.matched) {\n        if (record.beforeEnter && from.matched.indexOf(record) < 0) {\n          if (Array.isArray(record.beforeEnter)) {\n            for (const beforeEnter of record.beforeEnter)\n              guards.push(guardToPromiseFn(beforeEnter, to, from))\n          }\n          else {\n            guards.push(guardToPromiseFn(record.beforeEnter, to, from))\n          }\n        }\n      }\n      guards.push(canceledNavigationCheck)\n      return runGuardQueue(guards)\n    })\n    .then(() => {\n      to.matched.forEach(record => (record.enterCallbacks = {}))\n      guards = extractComponentsGuards(enteringRecords, 'beforeRouteEnter', to, from)\n      guards.push(canceledNavigationCheck)\n      return runGuardQueue(guards)\n    })\n    .then(() => {\n      guards = []\n      for (const guard of beforeResolveGuards.list()) {\n        guards.push(guardToPromiseFn(guard, to, from))\n      }\n      guards.push(canceledNavigationCheck)\n      return runGuardQueue(guards)\n    })\n    .catch(err => isNavigationFailure(err, 8 /* NAVIGATION_CANCELLED */)\n      ? err\n      : Promise.reject(err)))\n}\n")),(0,o.kt)("p",null,"\u53ef\u4ee5\u770b\u5230 navigate \u6267\u884c\u5bfc\u822a\u5b88\u536b\u7684\u65b9\u5f0f\u662f\u5148\u6784\u9020 guards \u6570\u7ec4\uff0c\u6570\u7ec4\u4e2d\u6bcf\u4e2a\u5143\u7d20\u90fd\u662f\u4e00\u4e2a\u8fd4\u56de Promise \u5bf9\u8c61\u7684\u51fd\u6570\u3002"),(0,o.kt)("p",null,"\u7136\u540e\u901a\u8fc7 runGuardQueue \u53bb\u6267\u884c\u8fd9\u4e9b guards:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"function runGuardQueue(guards) {\n  return guards.reduce((promise, guard) => promise.then(() => guard()), Promise.resolve())\n}\n")),(0,o.kt)("p",null,"\u5176\u5b9e\u5c31\u662f\u901a\u8fc7\u6570\u7ec4\u7684 reduce \u65b9\u6cd5\uff0c\u94fe\u5f0f\u6267\u884c guard \u51fd\u6570\uff0c\u6bcf\u4e2a guard \u51fd\u6570\u90fd\u4f1a\u8fd4\u56de\u4e00\u4e2a Promise\u5bf9\u8c61\u3002"),(0,o.kt)("p",null,"\u4f46\u662f\u4ece\u6211\u4eec\u7684\u4f8b\u5b50\u770b\uff0c\u6211\u4eec\u6dfb\u52a0\u7684\u662f\u4e00\u4e2a\u666e\u901a\u51fd\u6570\uff0c\u5e76\u4e0d\u662f\u4e00\u4e2a\u8fd4\u56de Promise\u5bf9\u8c61\u7684\u51fd\u6570\uff0c\u90a3\u662f\u600e\u4e48\u505a\u7684\u5462\uff1f"),(0,o.kt)("p",null,"\u539f\u6765\u5728\u628a guard \u6dfb\u52a0\u5230 guards \u6570\u7ec4\u524d\uff0c\u90fd\u4f1a\u6267\u884c guardToPromiseFn \u51fd\u6570\u628a\u666e\u901a\u51fd\u6570 Promise\u5316:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"import { warn as warn$1 } from \"vue/dist/vue\"\nfunction guardToPromiseFn(guard, to, from, record, name) {\n  const enterCallbackArray = record &&\n    (record.enterCallbacks[name] = record.enterCallbacks[name] || [])\n  return () => new Promise((resolve, reject) => {\n    const next = (valid) => {\n      if (valid === false)\n        reject(createRouterError(4 /* NAVIGATION_ABORTED */, {\n          from,\n          to,\n        }))\n      else if (valid instanceof Error) {\n        reject(valid)\n      }\n      else if (isRouteLocation(valid)) {\n        reject(createRouterError(2 /* NAVIGATION_GUARD_REDIRECT */, {\n          from: to,\n          to: valid\n        }))\n      }\n      else {\n        if (enterCallbackArray &&\n          record.enterCallbacks[name] === enterCallbackArray &&\n          typeof valid === 'function')\n          enterCallbackArray.push(valid)\n        resolve()\n      }\n    }\n    const guardReturn = guard.call(record && record.instances[name], to, from, next )\n    let guardCall = Promise.resolve(guardReturn)\n    if (guard.length < 3)\n      guardCall = guardCall.then(next)\n    if (guard.length > 2) {\n      const message = `The \"next\" callback was never called inside of ${guard.name ? '\"' + guard.name + '\"' : ''}:\\n${guard.toString()}\\n. If you are returning a value instead of calling \"next\", make sure to remove the \"next\" parameter from your function.`\n      if (typeof guardReturn === 'object' && 'then' in guardReturn) {\n        guardCall = guardCall.then(resolvedValue => {\n          // @ts-ignore: _called is added at canOnlyBeCalledOnce\n          if (!next._called) {\n            warn$1(message)\n            return Promise.reject(new Error('Invalid navigation guard'))\n          }\n          return resolvedValue\n        })\n      }\n      else if (guardReturn !== undefined) {\n        if (!next._called) {\n          warn$1(message)\n          reject(new Error('Invalid navigation guard'))\n          return\n        }\n      }\n    }\n    guardCall.catch(err => reject(err))\n  })\n}\n")),(0,o.kt)("p",null,"guardToPromiseFn \u51fd\u6570\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684\u51fd\u6570\uff0c\u8fd9\u4e2a\u51fd\u6570\u5185\u90e8\u4f1a\u6267\u884c guard \u51fd\u6570\u3002"),(0,o.kt)("p",null,"\u8fd9\u91cc\u6211\u4eec\u8981\u6ce8\u610f next \u65b9\u6cd5\u7684\u8bbe\u8ba1\uff0c\u5f53\u6211\u4eec\u5728\u5bfc\u822a\u5b88\u536b\u4e2d\u6267\u884c next \u65f6\uff0c\u5b9e\u9645\u4e0a\u5c31\u662f\u6267\u884c\u8fd9\u91cc\u5b9a\u4e49\u7684 next \u51fd\u6570\u3002"),(0,o.kt)("p",null,"\u5728\u6267\u884c next \u51fd\u6570\u65f6\uff0c\u5982\u679c\u4e0d\u4f20\u53c2\u6570\uff0c\u90a3\u4e48\u5219\u76f4\u63a5 resolve\uff0c\u6267\u884c\u4e0b\u4e00\u4e2a\u5bfc\u822a\u5b88\u536b\uff1b\u5982\u679c\u53c2\u6570\u662f false\uff0c\u5219\u521b\u5efa\u4e00\u4e2a\u5bfc\u822a\u53d6\u6d88\u7684\u9519\u8bef reject \u51fa\u53bb\uff1b\u5982\u679c\u53c2\u6570\u662f\u4e00\u4e2a Error \u5b9e\u4f8b\uff0c\u5219\u76f4\u63a5\u6267\u884c reject\uff0c\u5e76\u628a\u9519\u8bef\u4f20\u9012\u51fa\u53bb\uff1b\u5982\u679c\u53c2\u6570\u662f\u4e00\u4e2a\u8def\u5f84\u5bf9\u8c61\uff0c\u5219\u521b\u5efa\u4e00\u4e2a\u5bfc\u822a\u91cd\u5b9a\u5411\u7684\u9519\u8bef\u4f20\u9012\u51fa\u53bb\u3002"),(0,o.kt)("p",null,"\u6709\u4e9b\u65f6\u5019\u6211\u4eec\u5199\u5bfc\u822a\u5b88\u536b\u4e0d\u4f7f\u7528 next \u51fd\u6570\uff0c\u800c\u662f\u76f4\u63a5\u8fd4\u56de true \u6216 false\uff0c\u8fd9\u79cd\u60c5\u51b5\u5219\u5148\u6267\u884c\u5982\u4e0b\u4ee3\u7801\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-ts"},"guardCall = Promise.resolve(guardReturn)\n")),(0,o.kt)("p",null,"\u628a\u5bfc\u822a\u5b88\u536b\u7684\u8fd4\u56de\u503c Promise\u5316\uff0c\u7136\u540e\u518d\u6267\u884c guardCall.then(next)\uff0c\u628a\u5bfc\u822a\u5b88\u536b\u7684\u8fd4\u56de\u503c\u4f20\u7ed9 next \u51fd\u6570\u3002"),(0,o.kt)("p",null,"\u5f53\u7136\uff0c\u5982\u679c\u4f60\u5728\u5bfc\u822a\u5b88\u536b\u4e2d\u5b9a\u4e49\u4e86\u7b2c\u4e09\u4e2a\u53c2\u6570 next\uff0c\u4f46\u662f\u4f60\u6ca1\u6709\u5728\u51fd\u6570\u4e2d\u8c03\u7528\u5b83\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e5f\u4f1a\u62a5\u8b66\u544a\u3002"),(0,o.kt)("p",null,"\u6240\u4ee5\uff0c\u5bf9\u4e8e\u5bfc\u822a\u5b88\u536b\u800c\u8a00\uff0c\u7ecf\u8fc7 Promise\u5316\u540e\u6dfb\u52a0\u5230 guards \u6570\u7ec4\u4e2d\uff0c\u7136\u540e\u518d\u901a\u8fc7 runGuards \u4ee5\u53ca Promise \u7684\u65b9\u5f0f\u94fe\u5f0f\u8c03\u7528\uff0c\u6700\u7ec8\u4f9d\u6b21\u987a\u5e8f\u6267\u884c\u8fd9\u4e9b\u5bfc\u822a\u5b88\u536b\u3002"))}d.isMDXComponent=!0}}]);